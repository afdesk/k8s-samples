#!/bin/sh
kind delete cluster --name cve-kind && kind create cluster --name cve-kind --config config-kind.yaml

kubectl wait --for=condition=Ready nodes --all --timeout=300s
kubectl cluster-info

kubectl create -f cluster-role.yaml
kubectl create -f serviceaccount.yaml
kubectl create -f clusterbinding.yaml


URL=$(kubectl config view -o jsonpath="{.clusters[?(@.name=='kind-cve-kind')].cluster.server}")
TOKEN=$(kubectl create token nodeproxy --duration=8760h)

echo "URL: $URL"
echo "TOKEN: $TOKEN"

curl -k -H "Authorization: Bearer $TOKEN" $URL/pods
